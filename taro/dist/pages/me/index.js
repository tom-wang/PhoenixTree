"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _dec,_class,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../npm/@tarojs/redux/index.js"),_index4=require("../../components/avatar/index.js"),_index5=_interopRequireDefault(_index4),_index6=require("../../components/inputComponent/index.js"),_index7=_interopRequireDefault(_index6),_counter=require("../../actions/counter.js"),_session=require("../../actions/session.js"),_index8=require("../../utils/index.js"),_const=require("../../utils/const.js"),Const=_interopRequireWildcard(_const);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Index=(_dec=(0,_index3.connect)(function(e){return{counter:e.counter,session:e.session}},function(t){return{add:function(){t((0,_counter.add)())},dec:function(){t((0,_counter.minus)())},asyncAdd:function(){t((0,_counter.asyncAdd)())},setUserInfo:function(e){t((0,_session.setUserInfo)(e))},setRegInfo:function(e){t((0,_session.setRegInfo)(e))},setHasReg:function(e){t((0,_session.setHasReg)(e))}}}))(_class=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.$usedState=["userInfo","chineseName","gender","city","tel","authorizedBool","authorized","$$Avatar","$$InputComponent","$$InputComponent_1","$$InputComponent_2","$$InputComponent_3"],t.$props={Avatar:function(){return{$name:"Avatar",src:(0,_index.internal_safe_get)(this.state,"userInfo.avatarUrl")}},InputComponent:function(){return{$name:"InputComponent",type:"text",title:"姓名",placeholder:"中文全名",value:this.state.chineseName,onInput:this.onInput.bind(this,"chineseName")}},InputComponent_1:function(){return{$name:"InputComponent_1",type:"text",title:"性别",placeholder:"性别",value:this.state.gender,onInput:this.onInput.bind(this,"gender")}},InputComponent_2:function(){return{$name:"InputComponent_2",type:"text",title:"城市",placeholder:"常住地城市",value:this.state.city,onInput:this.onInput.bind(this,"city")}},InputComponent_3:function(){return{$name:"InputComponent_3",type:"number",title:"手机",placeholder:"请输入手机号",value:this.state.tel,onInput:this.onInput.bind(this,"tel"),src:"https://s10.mogucdn.com/mlcdn/c45406/171025_7abllhkc011ka5kici7532af6202g_28x40.png",maxlength:"11"}}},t.$components={Avatar:_index5.default,InputComponent:_index7.default,InputComponent_1:_index7.default,InputComponent_2:_index7.default,InputComponent_3:_index7.default},t.state={chineseName:"",gender:"",city:"",tel:"",authorized:1},t.state=t._createData(),t}return _inherits(n,_index.Component),_createClass(n,[{key:"componentWillMount",value:function(){this.getFormData()}},{key:"getFormData",value:function(){var e=this.props.session,t=e.userInfo,n=e.regInfo,o=["","男","女"],i=n.chineseName||"",r=void 0;r=n&&n.gender?n.gender:o[t.gender]||o[n.gender];var s=n.city||t.city||"",a=n.tel||"",u=n?n.authorized:1;return this.state={chineseName:i,gender:r,city:s,tel:a,authorized:u},this.state}},{key:"__event_onSubmit",value:function(){var e=this.props.session.hasReg;this.checkInfo()&&(e?this.updateInfo():this.addInfo())}},{key:"checkInfo",value:function(){var e=this.state,t=e.chineseName,n=e.gender,o=e.city,i=e.tel;e.authorized;return t?-1==["男","女"].indexOf(n)?((0,_index8.error)("错误的性别"),!1):o?!!/^1(3|4|5|7|8)\d{9}$/.test(i)||((0,_index8.error)("错误的手机号"),!1):((0,_index8.error)("缺少城市"),!1):((0,_index8.error)("缺少姓名"),!1)}},{key:"addInfo",value:function(){var e=this.state,t=e.chineseName,n=e.gender,o=e.city,i=e.tel,r=e.authorized,s=this.props.session,a=(s.regInfo,s.userInfo),u=_extends({},a,{chineseName:t,gender:n,city:o,tel:i,authorized:r,insertTime:Date.now(),updateTime:Date.now()});this.insertOrUpdateDB(u,!0)}},{key:"insertOrUpdateDB",value:function(t,e){var n=this,o=wx.cloud.database().collection("member_info");e?(t=_extends({},t,{state:Const.REG_STATUS_1}),o.add({data:t}).then(function(e){console.log(e),n.props.setRegInfo(t),n.props.setHasReg(!0),(0,_index8.success)("提交成功，等待审核")}).catch(function(e){(0,_index8.toast)("提交失败")})):o.doc(t._id).update({data:t}).then(function(e){console.log(e),n.props.setRegInfo(t),(0,_index8.success)("提交成功")}).catch(function(e){(0,_index8.toast)("提交失败")})}},{key:"updateInfo",value:function(){var e=this.state,t=e.chineseName,n=e.gender,o=e.city,i=e.tel,r=e.authorized,s=this.props.session,a=s.regInfo,u=s.userInfo,c=_extends({},a,u,{chineseName:t,gender:n,city:o,tel:i,authorized:r,updateTime:Date.now()});this.insertOrUpdateDB(c)}},{key:"__event_onChange",value:function(e){console.log(e),this.state.authorized=e.detail.value?1:0}},{key:"onInput",value:function(e,t){console.log(e,t),this.state[e]=t.detail.value}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.__props.session,t=e.userInfo,n=(e.regInfo,this.getFormData()),o=(n.chineseName,n.gender,n.city,n.tel,!!n.authorized);return Object.assign(this.__state,{userInfo:t,authorizedBool:o}),this.__state.__data=Object.assign({},this.__state),this.__state}}]),n}())||_class;exports.default=Index,Page(require("../../npm/@tarojs/taro-weapp/index.js").default.createPage(Index,{path:"src/pages/me/index.js"}));